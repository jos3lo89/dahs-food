---
import type { Product } from "../data/products";

interface Props {
  product: Product;
}

const { product } = Astro.props;
---

<div class="bg-white rounded-3xl shadow-lg overflow-hidden card-hover">
  <div class="relative h-56 overflow-hidden">
    <img
      src={product.image}
      alt={product.name}
      class="w-full h-full object-cover transition-transform duration-500 hover:scale-110"
    />
    <div
      class="absolute top-4 right-4 bg-pink-500 text-white px-4 py-2 rounded-full font-bold shadow-md"
    >
      S/ {product.price.toFixed(2)}
    </div>
  </div>

  <div class="p-6">
    <h3 class="text-2xl font-bold text-pink-900 mb-2">{product.name}</h3>
    <p class="text-gray-600 mb-6">{product.description}</p>

    <div class="flex items-center gap-4">
      <div class="flex items-center bg-pink-50 rounded-full overflow-hidden">
        <button
          class="decrease-btn px-4 py-2 text-pink-600 hover:bg-pink-100 transition font-bold cursor-pointer"
          data-id={product.id}
        >
          âˆ’
        </button>
        <span
          class="quantity px-4 py-2 font-semibold text-pink-900 cursor-default"
          data-id={product.id}>1</span
        >
        <button
          class="increase-btn px-4 py-2 text-pink-600 hover:bg-pink-100 transition font-bold cursor-pointer"
          data-id={product.id}
        >
          +
        </button>
      </div>

      <button
        class="add-to-cart-btn cursor-pointer flex-1 bg-pink-500 hover:bg-pink-600 text-white font-semibold px-6 py-3 rounded-full transition-all duration-300 hover:shadow-lg"
        data-product={JSON.stringify(product)}
      >
        Agregar ðŸ›’
      </button>
    </div>
  </div>
</div>

<script>
  import { addToCart, cartItems, updateQuantity } from "../store/cart";

  const updateDisplay = () => {
    const cart = cartItems.get();

    document.querySelectorAll(".quantity").forEach((el) => {
      const id = el.getAttribute("data-id");
      if (!id) return;

      const item = cart[id];
      const qtySpan = el as HTMLElement;

      if (item) {
        qtySpan.textContent = item.quantity.toString();
        qtySpan.classList.remove("opacity-50");
      } else {
        qtySpan.textContent = "1";
        qtySpan.classList.add("opacity-50");
      }
    });
  };

  cartItems.subscribe(updateDisplay);
  updateDisplay();

  document.querySelectorAll(".add-to-cart-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const productData = btn.getAttribute("data-product");
      if (productData) {
        const product = JSON.parse(productData);
        const card = btn.closest(".bg-white");
        const qtySpan = card?.querySelector(".quantity");
        const currentQty = parseInt(qtySpan?.textContent || "1");

        addToCart(product, currentQty);
      }
    });
  });

  document.querySelectorAll(".increase-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-id");
      if (!id) return;

      const cart = cartItems.get();
      const qtySpan = btn.parentElement?.querySelector(
        ".quantity"
      ) as HTMLElement;
      const currentVal = parseInt(qtySpan.textContent || "1");

      if (cart[id]) {
        updateQuantity(id, cart[id].quantity + 1);
      } else {
        qtySpan.textContent = (currentVal + 1).toString();
      }
    });
  });

  document.querySelectorAll(".decrease-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-id");
      if (!id) return;

      const cart = cartItems.get();
      const qtySpan = btn.parentElement?.querySelector(
        ".quantity"
      ) as HTMLElement;
      const currentVal = parseInt(qtySpan.textContent || "1");

      if (cart[id]) {
        if (cart[id].quantity > 1) {
          updateQuantity(id, cart[id].quantity - 1);
        }
      } else {
        if (currentVal > 1) {
          qtySpan.textContent = (currentVal - 1).toString();
        }
      }
    });
  });
</script>
